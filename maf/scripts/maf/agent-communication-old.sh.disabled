#!/bin/bash
# Agent communication and coordination system

SESSION_NAME="maf-5pane"
LOG_DIR=".agent-mail/logs"
COMM_LOG="$LOG_DIR/agent-communications.log"

mkdir -p "$LOG_DIR"

# Function to log communication
log_comm() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $1" | tee -a "$COMM_LOG"
}

# Function to send message from an agent
send_message() {
    local from_agent=$1
    local to_agent=$2
    local message=$3

    # Log the message
    log_comm "$from_agent -> $to_agent: $message"

    # Send to target agent's pane
    case $to_agent in
        "all"|"ALL")
            tmux send-keys -t "$SESSION_NAME:0.1" "echo '[$from_agent] $message'" Enter
            tmux send-keys -t "$SESSION_NAME:0.2" "echo '[$from_agent] $message'" Enter
            tmux send-keys -t "$SESSION_NAME:0.3" "echo '[$from_agent] $message'" Enter
            tmux send-keys -t "$SESSION_NAME:0.4" "echo '[$from_agent] $message'" Enter
            ;;
        "implementor-1"|"I1")
            tmux send-keys -t "$SESSION_NAME:0.1" "echo '[$from_agent] $message'" Enter
            ;;
        "implementor-2"|"I2")
            tmux send-keys -t "$SESSION_NAME:0.2" "echo '[$from_agent] $message'" Enter
            ;;
        "implementor-3"|"I3")
            tmux send-keys -t "$SESSION_NAME:0.3" "echo '[$from_agent] $message'" Enter
            ;;
        "reviewer"|"R")
            tmux send-keys -t "$SESSION_NAME:0.4" "echo '[$from_agent] $message'" Enter
            ;;
    esac
}

# Function to check if agent is idle (no recent activity)
check_agent_idle() {
    local pane=$1
    local agent_name=$2
    local timeout=${3:-60}  # 60 seconds default

    # Get last command from pane
    local last_cmd=$(tmux display-message -p -t "$SESSION_NAME:0.$pane" -T '#{pane_current_command}')

    # If just running claude with no activity
    if [[ "$last_cmd" == "claude" ]]; then
        # Check pane history
        local content=$(tmux capture-pane -t "$SESSION_NAME:0.$pane" -p | tail -5)
        if [[ -z "$content" ]] || [[ "$content" == *"Claude Code"* ]]; then
            return 0  # Agent is idle
        fi
    fi

    return 1  # Agent is active
}

# Function to send heartbeat ping
send_heartbeat() {
    local agent_name=$1
    local pane=$2

    # Send heartbeat message
    tmux send-keys -t "$SESSION_NAME:0.$pane" "echo 'â™¥ heartbeat: $agent_name alive at $(date +%H:%M:%S)'" Enter
    log_comm "HEARTBEAT: $agent_name at $(date)"
}

# Main communication coordinator
case "${1:-start}" in
    "start")
        log_comm "=== Starting Agent Communication System ==="

        # Start pinging agents every 30 seconds
        while true; do
            # Check each agent
            for agent_info in "1:implementor-1" "2:implementor-2" "3:implementor-3" "4:reviewer"; do
                pane=$(echo $agent_info | cut -d: -f1)
                agent=$(echo $agent_info | cut -d: -f2)

                if check_agent_idle $pane $agent; then
                    send_heartbeat $agent $pane
                fi
            done

            # Every 5 minutes, have agents ping each other
            if (( $(date +%s) % 300 < 30 )); then
                log_comm "=== Agent Ping Cycle ==="
                send_message "implementor-1" "all" "Ping from I1 - Status: Working on roundtable-vf5"
                sleep 2
                send_message "implementor-2" "all" "Ping from I2 - Status: Working on roundtable-dsg"
                sleep 2
                send_message "implementor-3" "all" "Ping from I3 - Status: Waiting for next task"
                sleep 2
                send_message "reviewer" "all" "Ping from Reviewer - Status: Monitoring all work"
            fi

            sleep 30
        done
        ;;

    "ping")
        # Manual ping from an agent
        if [ -z "$2" ]; then
            echo "Usage: $0 ping <agent-name> <message>"
            exit 1
        fi

        send_message "$2" "${3:-all}" "${4:-ping}"
        ;;

    "status")
        echo "=== Agent Communication Status ==="
        if [ -f "$COMM_LOG" ]; then
            echo "Total messages: $(wc -l < "$COMM_LOG")"
            echo ""
            echo "Recent activity:"
            tail -20 "$COMM_LOG"
        else
            echo "No communication logs yet"
        fi
        ;;

    "monitor")
        # Follow the communication log
        tail -f "$COMM_LOG"
        ;;
esac